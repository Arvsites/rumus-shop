<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Mybot Test</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #log { white-space: pre-wrap; background: #f5f5f5; padding: 10px; }
    button { padding: 10px 15px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>Mini App –ø–æ–¥–∫–ª—é—á–µ–Ω–∞</h1>
  <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É</button>
  <div id="log"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const logEl = document.getElementById("log");
    const btn = document.getElementById("send-btn");

    function log(line) {
      logEl.textContent += (logEl.textContent ? "\n" : "") + line;
    }

    // –í–∏–¥–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—É—Å–∫–∞
    const queryId = tg.initDataUnsafe?.query_id || "";
    const userId  = tg.initDataUnsafe?.user?.id || null;
    log(`[${new Date().toLocaleTimeString()}] SDK –≥–æ—Ç–æ–≤. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${tg.platform}.`);
    log(`query_id: ${queryId || "‚Äî"}`);

    btn.addEventListener("click", async () => {
      const payload = { event: "hello_from_miniapp", ts: Date.now() };

      try {
        if (queryId) {
          // –û—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫—É
          const r = await fetch("/api/inline_answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query_id: queryId, data: payload })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(JSON.stringify(j));
          log("‚úÖ –û—Ç–≤–µ—Ç–∏–ª–∏ –≤ —á–∞—Ç —á–µ—Ä–µ–∑ inline_answer.");
        } else if (tg.sendData) {
          // –û—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
          tg.sendData(JSON.stringify(payload));
          log("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É —á–µ—Ä–µ–∑ sendData (reply-–∫–Ω–æ–ø–∫–∞).");
        } else if (userId) {
          // –û—Ç–∫—Ä—ã—Ç–æ –ø–æ –∫–Ω–æ–ø–∫–µ ‚Äú–û—Ç–∫—Ä—ã—Ç—å‚Äù (–º–µ–Ω—é –±–æ—Ç–∞)
          const r = await fetch("/api/send_message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chat_id: userId,
              text: "üì¶ " + JSON.stringify(payload)
            })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(JSON.stringify(j));
          log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç —á–µ—Ä–µ–∑ sendMessage (–º–µ–Ω—é '–û—Ç–∫—Ä—ã—Ç—å').");
        } else {
          log("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–µ—Ç query_id –∏ userId).");
        }
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞: " + e.message);
      }
    });
  </script>
</body>
</html>
