<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Rumus Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:20px; }
    h1 { margin:0 0 12px; }
    button { padding:12px 16px; font-size:16px; border-radius:10px; border:1px solid #ddd; cursor:pointer; }
    #log { white-space: pre-wrap; background:#f6f8fa; border:1px solid #e5e7eb; padding:12px; border-radius:10px; margin-top:16px; }
  </style>
</head>
<body>
  <h1>Mini App –ø–æ–¥–∫–ª—é—á–µ–Ω–∞</h1>
  <button id="send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É</button>
  <div id="log"></div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const logEl = document.getElementById("log");
    const btn = document.getElementById("send-btn");
    const log = (s) => logEl.textContent += (logEl.textContent ? "\n" : "") + s;

    const queryId = tg.initDataUnsafe?.query_id || "";
    const userId  = tg.initDataUnsafe?.user?.id || null;

    log(`[${new Date().toLocaleTimeString()}] SDK –≥–æ—Ç–æ–≤. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${tg.platform}.`);
    log(`query_id: ${queryId || "‚Äî"}`);
    if (!userId) log("‚ÑπÔ∏è userId –Ω–µ –ø–æ–ª—É—á–µ–Ω (OK –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤).");

    btn.addEventListener("click", async () => {
      const payload = { event: "hello_from_miniapp", ts: Date.now() };

      try {
        if (queryId) {
          // –û—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ inline‚Äë–∫–Ω–æ–ø–∫—É
          const r = await fetch("/api/inline_answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query_id: queryId, data: payload })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j?.description || JSON.stringify(j));
          log("‚úÖ –û—Ç–≤–µ—Ç–∏–ª–∏ –≤ —á–∞—Ç —á–µ—Ä–µ–∑ answerWebAppQuery.");
        } else if (tg.sendData) {
          // –û—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ reply‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
          tg.sendData(JSON.stringify(payload));
          log("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É —á–µ—Ä–µ–∑ sendData (reply‚Äë–∫–Ω–æ–ø–∫–∞).");
        } else if (userId) {
          // –û—Ç–∫—Ä—ã—Ç–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –±–æ—Ç–∞ (¬´–û—Ç–∫—Ä—ã—Ç—å¬ª)
          const r = await fetch("/api/send_message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ chat_id: userId, text: "üì¶ " + JSON.stringify(payload) })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j?.description || JSON.stringify(j));
          log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç —á–µ—Ä–µ–∑ sendMessage (–º–µ–Ω—é ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª).");
        } else {
          log("‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏ (–Ω–µ—Ç query_id –∏ userId).");
        }
      } catch (e) {
        log("‚ùå –û—à–∏–±–∫–∞: " + (e?.message || e));
      }
    });
  </script>
</body>
</html>
