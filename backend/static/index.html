<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Rumus Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
    header, footer { padding:12px 16px; border-bottom:1px solid #eee; }
    main { padding:16px; }
    .hidden{ display:none; }
    .btn{ padding:10px 12px; border:1px solid #ddd; border-radius:10px; cursor:pointer; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .card{ border:1px solid #eee; border-radius:12px; padding:12px; width:100%; }
    @media(min-width:480px){ .card{ width:calc(50% - 6px); } }
    img{ max-width:100%; border-radius:8px; }
    input, select, textarea{ width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; }
    .back{ margin-right:8px; }
    .price{ font-weight:600; }
    .muted{ color:#666; font-size:12px; }
  </style>
</head>
<body>
<header class="row">
  <button class="btn back" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
  <div id="title">–ú–∞–≥–∞–∑–∏–Ω</div>
</header>
<main>
  <section id="screen-register" class="hidden">
    <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <div class="row">
      <input id="full_name" placeholder="–§–ò–û"/>
      <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω"/>
      <input id="email" placeholder="E-mail"/>
      <input id="ref" placeholder="–ö–æ–¥ –¥–∏—Å—Ç—Ä–∏–±—å—é—Ç–æ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)"/>
      <label><input type="checkbox" id="agree"/> –°–æ–≥–ª–∞—Å–µ–Ω —Å <a href="#" target="_blank">–ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ü–î–Ω</a></label>
      <button class="btn" id="regBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    </div>
  </section>

  <section id="screen-list" class="hidden">
    <div id="list" class="row"></div>
  </section>

  <section id="screen-product" class="hidden">
    <div id="pbox"></div>
  </section>

  <section id="screen-cart" class="hidden">
    <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
    <div id="cartBox"></div>
    <div class="row">
      <button class="btn" id="toCheckout">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </section>

  <section id="screen-checkout" class="hidden">
    <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
    <textarea id="addr" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
    <select id="delivery"><option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option><option value="courier">–ö—É—Ä—å–µ—Ä</option></select>
    <button class="btn" id="makeOrder">–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
  </section>

  <section id="screen-orders" class="hidden">
    <h2>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
    <div id="ordersBox"></div>
  </section>
</main>
<footer class="row">
  <button class="btn" id="navShop">–ö–∞—Ç–∞–ª–æ–≥</button>
  <button class="btn" id="navCart">–ö–æ—Ä–∑–∏–Ω–∞</button>
  <button class="btn" id="navOrders">–ò—Å—Ç–æ—Ä–∏—è</button>
</footer>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.setBackgroundColor("#ffffff");
tg.setHeaderColor("#ffffff");
const state = { stack: [], me: null, products: [] };
const titleEl = document.getElementById("title");
const screens = ["register","list","product","cart","checkout","orders"];
const show = (name) => {
  screens.forEach(s => document.getElementById("screen-"+s).classList.add("hidden"));
  document.getElementById("screen-"+name).classList.remove("hidden");
  titleEl.textContent = {
    register:"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", list:"–ö–∞—Ç–∞–ª–æ–≥", product:"–¢–æ–≤–∞—Ä",
    cart:"–ö–æ—Ä–∑–∏–Ω–∞", checkout:"–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ", orders:"–ò—Å—Ç–æ—Ä–∏—è"
  }[name] || "–ú–∞–≥–∞–∑–∏–Ω";
  state.stack.push(name);
};
document.getElementById("backBtn").onclick = () => {
  state.stack.pop(); // current
  const prev = state.stack.pop() || "list";
  show(prev);
};
const api = (p, opt={}) => fetch(p, { headers:{'Content-Type':'application/json'}, ...opt}).then(r=>r.json());

const uid = tg.initDataUnsafe?.user?.id || null;
if (!uid) { alert("–ù–µ—Ç user.id –æ—Ç Telegram"); }
const queryId = tg.initDataUnsafe?.query_id || "";

// bootstrap
(async function init(){
  // decide first screen
  await api("/api/products").then(ps => state.products = ps);
  // registration screen always first (–ª–∞–π—Ç-–ø—Ä–æ—Ñ–∏–ª—å –≤ –ë–î)
  show("register");
})();

// register
document.getElementById("regBtn").onclick = async () => {
  const payload = {
    tg_user_id: uid,
    full_name: v("full_name"), phone: v("phone"), email: v("email"),
    referral_code: v("ref"), agreed: q("#agree").checked, policy_version: "v1"
  };
  const r = await api("/api/register",{method:"POST", body: JSON.stringify(payload)});
  if (!r.ok) { return alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"); }
  // after register go to list
  renderList(); show("list");
  // send message to chat that user registered (best-effort)
  const data = { event:"registered", uid, ts:Date.now() };
  if (queryId) {
    await api("/api/inline_answer",{method:"POST", body: JSON.stringify({query_id: queryId, data})});
  } else if (tg.sendData) {
    tg.sendData(JSON.stringify(data));
  } else {
    await api("/api/send_message",{method:"POST", body: JSON.stringify({chat_id: uid, text: "üëã –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"})});
  }
};

function v(id){ return document.getElementById(id).value.trim(); }
function q(sel){ return document.querySelector(sel); }

function renderList(){
  const box = document.getElementById("list"); box.innerHTML = "";
  state.products.forEach(p=>{
    const el = document.createElement("div"); el.className="card";
    el.innerHTML = `
      ${p.images?.[0] ? `<img src="${p.images[0]}" alt="">`:""}
      <div class="row"><div><b>${p.title}</b></div><div class="price">${fmt(p.price_cents)}</div></div>
      <p class="muted">${p.description||""}</p>
      <div class="row">
        <button class="btn" data-id="${p.id}">–û—Ç–∫—Ä—ã—Ç—å</button>
        <button class="btn add" data-id="${p.id}">–í –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>`;
    el.querySelector("[data-id]").onclick = ()=>openProduct(p.id);
    el.querySelector(".add").onclick = ()=>addToCart(p.id,1);
    box.appendChild(el);
  });
}

async function openProduct(id){
  const p = await api("/api/products/"+id);
  const box = document.getElementById("pbox");
  box.innerHTML = `
    ${p.images?.[0]? `<img src="${p.images[0]}">`:""}
    <h2>${p.title}</h2>
    <div class="price">${fmt(p.price_cents)}</div>
    <p>${p.description||""}</p>
    <div class="row">
      <button class="btn" id="pAdd">–í –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>`;
  document.getElementById("pAdd").onclick = ()=>addToCart(p.id,1);
  show("product");
}

async function addToCart(product_id, qty){
  await api(`/api/cart/${uid}/items`, {method:"POST", body: JSON.stringify({product_id, qty})});
  await renderCart();
}

async function renderCart(){
  const c = await api(`/api/cart/${uid}`);
  const box = document.getElementById("cartBox"); box.innerHTML = "";
  if (!c.items?.length){ box.textContent = "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"; return; }
  c.items.forEach(it=>{
    const el = document.createElement("div"); el.className="card";
    el.innerHTML = `
      <div class="row"><b>${it.title}</b><span class="price">${fmt(it.price_cents)}</span></div>
      <div class="row">
        <input type="number" min="1" value="${it.qty}" style="width:90px" />
        <button class="btn save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn del">–£–¥–∞–ª–∏—Ç—å</button>
      </div>`;
    el.querySelector(".save").onclick = async ()=> {
      const qty = parseInt(el.querySelector("input").value||"1",10);
      await api(`/api/cart/items/${it.id}`, {method:"PATCH", body: JSON.stringify({product_id: it.product_id, qty})});
      await renderCart();
    };
    el.querySelector(".del").onclick = async ()=> {
      await api(`/api/cart/items/${it.id}`, {method:"DELETE"});
      await renderCart();
    };
    box.appendChild(el);
  });
  const total = document.createElement("p"); total.innerHTML = `<b>–ò—Ç–æ–≥–æ: ${fmt(c.total_cents)}</b>`;
  box.appendChild(total);
}

document.getElementById("toCheckout").onclick = ()=> show("checkout");
document.getElementById("makeOrder").onclick = async ()=>{
  const r = await api("/api/orders",{method:"POST", body: JSON.stringify({
    tg_user_id: uid, address: q("#addr").value.trim(), delivery_method: q("#delivery").value
  })});
  if (!r.ok){ return alert("–û—à–∏–±–∫–∞ –∑–∞–∫–∞–∑–∞"); }
  alert("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω: " + r.order_number);
  await renderOrders();
  show("orders");
};

async function renderOrders(){
  const list = await api(`/api/orders/${uid}`);
  const box = document.getElementById("ordersBox"); box.innerHTML = "";
  if (!list.length){ box.textContent = "–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç"; return; }
  list.forEach(o=>{
    const el = document.createElement("div"); el.className="card";
    el.innerHTML = `<b>‚Ññ ${o.number}</b> ¬∑ –°—Ç–∞—Ç—É—Å: ${o.status} ¬∑ –ò—Ç–æ–≥–æ: ${fmt(o.total_cents)}<br>
    <div class="muted">–ü–æ–∑–∏—Ü–∏–∏:</div>
    <ul>${o.items.map(i=>`<li>${i.title} √ó ${i.qty} ‚Äî ${fmt(i.price_cents)}</li>`).join("")}</ul>`;
    box.appendChild(el);
  });
}

function fmt(c){ return (c/100).toFixed(2) + " ‚ÇΩ"; }

// navbar
document.getElementById("navShop").onclick = ()=>{ renderList(); show("list"); };
document.getElementById("navCart").onclick = async ()=>{ await renderCart(); show("cart"); };
document.getElementById("navOrders").onclick = async ()=>{ await renderOrders(); show("orders"); };

</script>
</body>
</html>
