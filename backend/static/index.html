<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;padding:16px}
    button{padding:12px 16px;font-size:16px;border-radius:8px;border:1px solid #ccc;cursor:pointer}
    pre{white-space:pre-wrap;background:#f6f6f6;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <h1>Mini App<br/>подключена</h1>
  <button id="sendBtn">Отправить данные боту</button>
  <pre id="log"></pre>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const log = (m) => { document.getElementById('log').textContent += m + "\n"; };

const init = tg.initDataUnsafe || {};
const queryId = init.query_id || null;   // есть только при запуске из Attachment Menu
log(`[${new Date().toLocaleTimeString()}] SDK готов. Платформа: ${tg.platform}.`);
log(`query_id: ${queryId ?? '—'}`);
if(!queryId){ log("❗ query_id не найден (значит открыт по inline‑кнопке)."); }

document.getElementById('sendBtn').onclick = async () => {
  const payload = JSON.stringify({ event: 'hello_from_miniapp', ts: Date.now() });

  if (queryId) {
    // Attachment Menu: шлём на бэкенд, который вызовет answerWebAppQuery
    try {
      const r = await fetch('/api/webapp/answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query_id: queryId, text: payload })
      });
      const j = await r.json();
      log(j.ok ? "✅ Сообщение отправлено через answerWebAppQuery." :
                 "❌ Ошибка: " + JSON.stringify(j));
    } catch (e) {
      log("❌ Ошибка сети: " + e);
    }
  } else {
    // Inline‑кнопка: просто отправляем данные в бот
    tg.sendData(payload);
    log("✅ Отправлено боту через sendData (inline‑кнопка).");
  }
};
</script>
</body>
</html>
